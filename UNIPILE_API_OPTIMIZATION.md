# üöÄ Unipile API Optimization Guide

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Unipile API –≤–æ–∑–Ω–∏–∫–∞–ª–∏ —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
- API –≤–æ–∑–≤—Ä–∞—â–∞–ª —Ç–æ–ª—å–∫–æ 3 —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –≤–æ–æ–±—â–µ 0, –¥–∞–∂–µ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ 1000
- –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –ø–∞–≥–∏–Ω–∞—Ü–∏—è —á–µ—Ä–µ–∑ `cursor`
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç API —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç **250 —Å–æ–æ–±—â–µ–Ω–∏–π** –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
- –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–µ—Ä–µ–≥—Ä—É–∂–∞–ª–∞ —Å–µ—Ä–≤–µ—Ä (200 –ú–ë —Å–≤–æ–±–æ–¥–Ω–æ–π –û–ó–£ –Ω–∞ –ø—Ä–æ–¥–µ)

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. **–î–æ–±–∞–≤–ª–µ–Ω–∞ cursor-–ø–∞–≥–∏–Ω–∞—Ü–∏—è**

–ú–µ—Ç–æ–¥ `listChatMessages()` —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä `cursor` –¥–ª—è –ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:

```php
$unipileService->listChatMessages($accountId, $chatId, $limit = 50, $cursor = null);
```

**–í–∞–∂–Ω–æ:**
- API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º **250 —Å–æ–æ–±—â–µ–Ω–∏–π** –∑–∞ –∑–∞–ø—Ä–æ—Å
- –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `cursor` –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞

### 2. **–°–æ–∑–¥–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞**

`getMessagesForAnalysis()` - —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:

```php
$result = $unipileService->getMessagesForAnalysis($accountId, $chatId, $maxMessages = 100);
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
// [
//     'messages' => [...],      // –ú–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
//     'total' => 100,           // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö
//     'batches_used' => 2       // –°–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
// ]
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç **–º–∞–∫—Å–∏–º—É–º 100 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π** (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **–º–∞–ª–µ–Ω—å–∫–∏–µ –±–∞—Ç—á–∏ –ø–æ 50 —Å–æ–æ–±—â–µ–Ω–∏–π** (–Ω–∏–∑–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏)
- ‚úÖ –ú–∞–∫—Å–∏–º—É–º **3 –∑–∞–ø—Ä–æ—Å–∞ –∫ API** (150 —Å–æ–æ–±—â–µ–Ω–∏–π –º–∞–∫—Å)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –±–∞—Ç—á–∞
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### 3. **–û–±–Ω–æ–≤–ª–µ–Ω AutoTagContact Job**

–¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ:

**–ë—ã–ª–æ:**
```php
$messages = $unipileService->listChatMessages($accountId, $chatId, 1000);
// ‚ùå –ó–∞–ø—Ä–∞—à–∏–≤–∞–ª 1000, –ø–æ–ª—É—á–∞–ª —Ç–æ–ª—å–∫–æ 3-250
// ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª cursor
```

**–°—Ç–∞–ª–æ:**
```php
$messagesResult = $unipileService->getMessagesForAnalysis($accountId, $chatId, 100);
// ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç –¥–æ 100 —Å–æ–æ–±—â–µ–Ω–∏–π —Å cursor-–ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
// ‚úÖ –ú–∞–ª–µ–Ω—å–∫–∏–µ –±–∞—Ç—á–∏ (50 —Å–æ–æ–±—â–µ–Ω–∏–π)
// ‚úÖ –ù–∏–∑–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
```

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤

### `getMessagesForAnalysis()` - –¥–ª—è —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)
```php
$result = $unipileService->getMessagesForAnalysis($accountId, $chatId, 100);
```
- **–¶–µ–ª—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
- **–õ–∏–º–∏—Ç:** 100 —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞)
- **–ë–∞—Ç—á–∏:** 50 —Å–æ–æ–±—â–µ–Ω–∏–π √ó 3 –∑–∞–ø—Ä–æ—Å–∞ = 150 –º–∞–∫—Å
- **–ü–∞–º—è—Ç—å:** ~5-10 –ú–ë
- **–í—Ä–µ–º—è:** 0.5-1 —Å–µ–∫—É–Ω–¥–∞

### `getAllChatMessages()` - –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞ (–û–°–¢–û–†–û–ñ–ù–û!)
```php
$result = $unipileService->getAllChatMessages($accountId, $chatId, 500, 100);
```
- **–¶–µ–ª—å:** –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ–π –ø–µ—Ä–µ–ø–∏—Å–∫–∏, –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
- **–õ–∏–º–∏—Ç:** 500 —Å–æ–æ–±—â–µ–Ω–∏–π (–∏–ª–∏ –±–æ–ª—å—à–µ)
- **–ë–∞—Ç—á–∏:** 100 —Å–æ–æ–±—â–µ–Ω–∏–π √ó 10 –∑–∞–ø—Ä–æ—Å–æ–≤ = 1000 –º–∞–∫—Å
- **–ü–∞–º—è—Ç—å:** ~50-100 –ú–ë
- **–í—Ä–µ–º—è:** 2-5 —Å–µ–∫—É–Ω–¥

### `listChatMessages()` - –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
```php
$result = $unipileService->listChatMessages($accountId, $chatId, 50, $cursor);
```
- **–¶–µ–ª—å:** –†—É—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å API, –∫–∞—Å—Ç–æ–º–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è
- **–õ–∏–º–∏—Ç:** –î–æ 250 –∑–∞ –∑–∞–ø—Ä–æ—Å (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ API)
- **Cursor:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
- **–ü–∞–º—è—Ç—å:** –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
```php
// ‚úÖ –ò–°–ü–û–õ–¨–ó–£–ô–¢–ï –≠–¢–û
$result = $unipileService->getMessagesForAnalysis($accountId, $chatId, 100);
$tag = $chatAnalysisService->analyzeChatMessages($result['messages']);
```

### –î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–µ—Ä–µ–ø–∏—Å–∫–∏
```php
// ‚ö†Ô∏è –û–°–¢–û–†–û–ñ–ù–û: –í—ã—Å–æ–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
if (env('APP_ENV') !== 'production' || memory_get_usage() < 100 * 1024 * 1024) {
    $result = $unipileService->getAllChatMessages($accountId, $chatId, 500);
}
```

### –î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∞–ª—Ç–∞–π–º-—Å—Ç—Ä–∏–º–æ–º
```php
// ‚úÖ –°–¢–†–ò–ú–ò–ù–ì (—Å–∞–º–æ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤)
$unipileService->streamChats($accountId, function($items, $page, $cursor) {
    foreach ($items as $chat) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞
    }
    return true; // –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–ª–∏ false –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
}, $batchSize = 50, $maxPages = 20);
```

## üêõ –î–µ–±–∞–≥–≥–∏–Ω–≥

–ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:**
```bash
tail -f storage/logs/laravel.log | grep "AutoTagContact\|UnipileService"
```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ cursor –≤ –æ—Ç–≤–µ—Ç–µ:**
```php
$result = $unipileService->listChatMessages($accountId, $chatId, 50);
Log::info('Cursor:', ['cursor' => $result['cursor'], 'total' => $result['total']]);
```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏–º–∏—Ç—ã Unipile API:**
- –ú–∞–∫—Å–∏–º—É–º 250 —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ –∑–∞–ø—Ä–æ—Å
- Rate limiting: ~100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —á–∞—Ç—ã –º–æ–≥—É—Ç –Ω–µ –∏–º–µ—Ç—å –∏—Å—Ç–æ—Ä–∏–∏ (–∞—Ä—Ö–∏–≤–Ω—ã–µ, —É–¥–∞–ª—ë–Ω–Ω—ã–µ)

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–º —á–∞—Ç –≤ Unipile:**
```bash
curl -X GET "https://api14.unipile.com:14426/api/v1/chats/{chatId}/messages?limit=250" \
  -H "X-DSN: your-dsn" \
  -H "X-API-KEY: your-api-key"
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–î–æ–±–∞–≤–ª–µ–Ω—ã –ª–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:

```
[INFO] AutoTagContact: Starting tagging process
[DEBUG] Retrieved message batch (batch: 1, batch_size: 50, total_retrieved: 50, has_cursor: true)
[DEBUG] Retrieved message batch (batch: 2, batch_size: 50, total_retrieved: 100, has_cursor: false)
[INFO] Completed message retrieval for analysis (total_messages: 100, batches_used: 2)
[INFO] ChatAnalysisService: Successful analysis (category: crypto, confidence: 0.85)
[INFO] AutoTagContact: Successfully tagged contact (tag: crypto)
```

## üö® –í–∞–∂–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–ü–∞–º—è—Ç—å –Ω–∞ –ø—Ä–æ–¥–µ:** 200 –ú–ë —Å–≤–æ–±–æ–¥–Ω–æ–π –û–ó–£
   - `getMessagesForAnalysis()`: ~5-10 –ú–ë ‚úÖ
   - `getAllChatMessages(500)`: ~50-100 –ú–ë ‚ö†Ô∏è
   - `getAllChatMessages(2000)`: ~200+ –ú–ë ‚ùå

2. **Unipile API –ª–∏–º–∏—Ç—ã:**
   - –ú–∞–∫—Å–∏–º—É–º 250 —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ –∑–∞–ø—Ä–æ—Å
   - Rate limit: ~100 req/min
   - Cursor –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 5 –º–∏–Ω—É—Ç

3. **–ö–∞—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏–∑–∞:**
   - 50-100 —Å–æ–æ–±—â–µ–Ω–∏–π: –æ—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
   - 20-50 —Å–æ–æ–±—â–µ–Ω–∏–π: —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ
   - <20 —Å–æ–æ–±—â–µ–Ω–∏–π: —Å—Ä–µ–¥–Ω–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ
   - <5 —Å–æ–æ–±—â–µ–Ω–∏–π: –Ω–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ

## ‚úÖ –ò—Ç–æ–≥

–¢–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
- ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç **–±–æ–ª—å—à–µ —Å–æ–æ–±—â–µ–Ω–∏–π** –±–ª–∞–≥–æ–¥–∞—Ä—è cursor-–ø–∞–≥–∏–Ω–∞—Ü–∏–∏
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **–º–∏–Ω–∏–º—É–º –ø–∞–º—è—Ç–∏** (5-10 –ú–ë –≤–º–µ—Å—Ç–æ 50-200 –ú–ë)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç **–±—ã—Å—Ç—Ä–æ** (0.5-1 —Å–µ–∫ –≤–º–µ—Å—Ç–æ 2-5 —Å–µ–∫)
- ‚úÖ **–ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ—Ç** production —Å–µ—Ä–≤–µ—Ä
- ‚úÖ **–õ–æ–≥–∏—Ä—É–µ—Ç** –ø—Ä–æ—Ü–µ—Å—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞!** üéâ






